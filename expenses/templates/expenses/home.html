{% extends "index.html" %}


{% block title %}Home{% endblock %}

{% block content %}
<h1 class="mb-3 pt-3">Home</h1>
<hr>
<div class="my-5 border border-secondary rounded-4 mx-5">
    <div class="row p-4 ">
        <form method="GET" action="{% url 'home' %}" class="d-flex gap-3 mb-4">
            <div>
                <input type="month" name="date" class="form-control bg-dark text-white border-dark"
                    value="{{ selected_date }}" /> <!-- Now retains selected or default month -->
            </div>
            <div>
                <button type="submit" class="btn btn-dark text-info">Filter</button>
            </div>
        </form>

        <div class="bg-dark mx-auto my-3 rounded-4 col-lg-3 col-12 p-3 text-success">
            <h3>Total Credit</h3>
            <h2>₹ {{ total_credit}}</h2>
        </div>
        <div class="bg-dark mx-auto my-3 rounded-4 col-lg-3 col-12 p-3 text-danger">
            <h3>Total Debit</h3>
            <h2>₹ {{ total_debit}} </h2>
        </div>
        <div class="bg-dark mx-auto my-3 rounded-4 col-lg-3 col-12 p-3">
            <h3>Balance</h3>
            <h2>₹ {{ balance }}</h2>
        </div>
    </div>


</div>
<!-- <hr> -->

<div class="mt-5 p-0">
    <div id="apexcharts-area" class="bg-black p-0 m-0 col-lg-12 "></div>
    <div id="no-data-message" style="display: none; color: red;">No data available.</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<script>
    // Passing the data from Django to JavaScript
    var summaryData = JSON.parse('{{ summary_data|escapejs }}');
    if (summaryData.length > 0) {
        var months = summaryData.map(item => item.month);
        var creditPercentages = summaryData.map(item => item.credit_percentage);
        var debitPercentages = summaryData.map(item => item.debit_percentage);
        var totalExpenses = summaryData.map(item => item.total_expens);

        document.getElementById('apexcharts-area').style.display = 'block';

        var options = {
            chart: {
                height: 500,
                type: "area",
                background: "black",
                foreColor: "#ffffff",
                toolbar: { show: false }
            },
            dataLabels: { enabled: false },
            stroke: { curve: "smooth" },

            // ✅ Three curves: Total Expense, Credit%, Debit%
            series: [
                { name: "Total Expense (₹)", data: totalExpenses },
                { name: "Credit %", data: creditPercentages },
                { name: "Debit %", data: debitPercentages }
            ],
            colors: ["#ttt", "#198754", "#DC3545"],  // Orange, Green, Red

            xaxis: {
                categories: months,
                title: {
                    text: "Month",
                    style: { color: "#ffffff" }
                }
            },

            yaxis: [
                {
                    labels: {
                        formatter: function (value) {
                            return "₹" + value.toFixed(0);
                        },
                        style: { colors: "#FFA500" }
                    },
                    title: {
                        text: "Total Expense (₹)",
                        style: { color: "#FFA500" }
                    }
                },
                {
                    opposite: true,  // Place percentages on the right Y-axis
                    labels: {
                        formatter: function (value) {
                            return value.toFixed(1) + "%";
                        },
                        style: { colors: ["#198754", "#DC3545"] }
                    },
                    title: {
                        text: "Credit/Debit %",
                        style: { color: "#ffffff" }
                    }
                }
            ],

            tooltip: {
                custom: function ({ dataPointIndex }) {
                    return `
                    <div style="background:rgba(0, 0, 0, 0.7); padding:10px; border-radius:5px; color:#fff;">
                        <strong>${months[dataPointIndex]}</strong><br> 
                        <hr style="border: 0.5px solid #555;">
                        <strong style="color:#FFA500;">Total Expense:</strong> ₹${totalExpenses[dataPointIndex].toFixed(2)}<br>
                        <strong style="color:#198754;">Credit:</strong> ${creditPercentages[dataPointIndex].toFixed(2)}%<br>
                        <strong style="color:#DC3545;">Debit:</strong> ${debitPercentages[dataPointIndex].toFixed(2)}%
                    </div>
                `;
                }
            },

            theme: { mode: "dark" }
        };

        var chart = new ApexCharts(document.querySelector("#apexcharts-area"), options);
        chart.render();
    } else {
        document.getElementById('no-data-message').style.display = 'block';
    }

</script>

{% endblock %}